# 实现一致性与配置化设计

## 背景与问题

当前项目支持通过 SPI 扩展多类插件，但存在配置化不一致的问题：
- 序列化器：`SerializerFactory` 允许通过系统属性 `-Dserializer.type` 覆盖，但未统一到应用配置文件。
- 负载均衡：客户端通过 `LoadBalanceFactory` 基于 SPI 与 `BalanceType` 选择；`ZKServiceCenter` 默认一致性哈希，缺少集中配置入口。
- 限流：`RateLimitProvider` 通过 SPI 加载实现，参数通过 `-Dratelimit.*` 系统属性外部化，但缺少统一配置文件与服务级参数能力。
- Zookeeper：`ZKServiceCenter` 使用硬编码 `127.0.0.1:2285`、`MY_RPC` 等。

以上导致：
- 配置分散（系统属性、硬编码、构造参数），不可追踪。
- 环境切换成本高，难以一次性声明式配置。
- 插件“默认实现”不一致，存在取第一个 SPI 实现、或默认某实现的差异。

## 目标
- 统一从 `src/main/resources/application.properties` 读取配置，支持系统属性覆盖。
- 所有插件均支持“显式命名选择 + SPI 校验兜底 + 明确默认实现”。
- 所有插件参数可在配置文件中外部化，支持服务级覆盖（当适用）。
- 移除硬编码端点与魔法常量（例如 ZK 连接串、命名空间、负载均衡默认类型、限流桶参数）。

## 范围
- 序列化器（`common.serializer`）
- 负载均衡（`client.serviceCenter.balance`）
- 限流（`server.provider.ratelimit`）
- Zookeeper 客户端参数（`client.serviceCenter.ZKServiceCenter`）

## 配置约定（application.properties）
- 序列化
  - rpc.serializer.type=protobuf|json|object|code(0/1/2)
- 负载均衡
  - rpc.loadbalance.type=consistency_hash|random|sequence|lstm
- Zookeeper
  - rpc.zk.connect=127.0.0.1:2285
  - rpc.zk.sessionTimeoutMs=40000
  - rpc.zk.namespace=MY_RPC
- 限流（全局默认）
  - rpc.ratelimit.impl=configurable_token_bucket|token_bucket|synchronized_token_bucket
  - rpc.ratelimit.rate.ms=10
  - rpc.ratelimit.capacity=300

说明：系统属性可覆盖上述键，例如 `-Drpc.zk.connect=...`。

## 设计与实现
1) 新增 `common.util.AppConfig`
- 职责：加载 `application.properties`（classpath 根），提供 `getString/getInt/getEnum` API；系统属性优先。

2) 序列化器改造
- 在 `SerializerFactory#getSerializerByCode` 中优先读取 `rpc.serializer.type`；
- 兼容旧 `-Dserializer.type`；
- 明确最优默认：Protobuf（若已注册），否则 JSON。

3) 负载均衡改造
- 新增从 `AppConfig` 读取 `rpc.loadbalance.type`；
- `NettyRpcClient()` 无参构造使用配置的类型；
- `LoadBalanceFactory` 除根据 `BalanceType` 外，新增 `fromName(String)`；默认最优：`consistency_hash`。

4) 限流改造
- `RateLimitProvider` 读取 `rpc.ratelimit.impl`，按名称优先匹配 SPI 实现；
- 对 `configurable_token_bucket` 支持从配置读取 `rate.ms/capacity`（透传给实现或在 Provider 层构造）；
- 默认最优：`configurable_token_bucket`。

5) ZK 参数外部化
- `ZKServiceCenter` 构造函数读取 `rpc.zk.*`；
- 保留重载以便单测注入。

## 兼容性
- 现有系统属性覆盖仍然生效但优先级低于 `rpc.*` 同名系统属性。
- 未提供 `application.properties` 时，使用当前默认行为（一致性哈希、JSON/Protobuf、令牌桶默认参数、ZK 默认值）。

## 代码变更点
- 新增：`common.util.AppConfig`
- 修改：
  - `common.serializer.SerializerFactory`
  - `client.rpcClient.impl.NettyRpcClient`
  - `client.serviceCenter.balance.LoadBalanceFactory`
  - `client.serviceCenter.ZKServiceCenter`
  - `server.provider.ratelimit.RateLimitProvider`
- 新增资源：`src/main/resources/application.properties`（示例缺省配置）。

## 默认最优实现说明
- 序列化：Protobuf（带类型显式字段，性能更优）；若不可用，则 JSON。
- 负载均衡：一致性哈希（请求亲和 + 扩缩容稳定性）。
- 限流：可配置令牌桶（更易运维调参）。

## 验收
- 无配置 → 行为与当前保持一致或更优默认。
- 提供配置 → 插件选择与参数按配置生效。
- 基础并发测试（`client.ConcurrentTestClient`）通过；限流单测通过；序列化单测通过。
